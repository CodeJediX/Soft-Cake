<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Soft Cake</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #c69c6d;
            --primary-dark: #a67c52;
            --white: #ffffff;
            --text-dark: #2c2c2c;
            --bg-light: #f4f6f9;
            --danger: #e74c3c;
            --success: #27ae60;
            --info: #2980b9;
            --warning: #f39c12;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; outline: none; }
        
        body { background: var(--bg-light); color: var(--text-dark); transition: 0.3s; }

        /* --- TOAST NOTIFICATIONS --- */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 3000; }
        .toast {
            background: white; padding: 15px 25px; margin-bottom: 10px; border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 10px;
            border-left: 5px solid var(--primary); animation: slideIn 0.3s ease-out; min-width: 250px;
        }
        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--danger); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* --- LOGIN OVERLAY --- */
        .login-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(44, 44, 44, 0.95); 
            display: flex; justify-content: center; align-items: center; 
            z-index: 2000; 
        }
        .login-box { 
            background: white; padding: 40px; width: 350px; 
            border-radius: 12px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
        }
        .login-box h2 { font-family: 'Playfair Display', serif; margin-bottom: 20px; color: var(--primary); }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px; }
        
        /* --- DASHBOARD --- */
        .admin-header {
            background: var(--white); padding: 15px 40px; 
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100;
        }
        .logo { font-family: 'Playfair Display', serif; font-weight: 700; font-size: 1.5rem; }
        .logo span { color: var(--primary); }

        .main-container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }

        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); text-align: center; transition: 0.3s; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.05); }
        .stat-card h3 { font-size: 2rem; color: var(--primary); margin-bottom: 5px; }
        .stat-card p { color: #888; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }

        /* Forms & Filters */
        .panel { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); margin-bottom: 30px; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; flex-wrap: wrap; gap: 15px; }
        .panel h3 { font-family: 'Playfair Display', serif; color: #333; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-width { grid-column: 1 / -1; }
        
        .input-group label { display: block; font-size: 0.8rem; color: #666; margin-bottom: 5px; font-weight: 600; }
        input, select, textarea { 
            width: 100%; padding: 10px 15px; border: 1px solid #ddd; border-radius: 6px; 
            font-size: 0.9rem; transition: 0.2s; background: #fff;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(198, 156, 109, 0.1); }

        /* Search Bar */
        .search-bar { display: flex; gap: 10px; width: 100%; max-width: 400px; }
        
        /* Buttons */
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: 0.3s; display: inline-flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--success); color: white; }
        .btn-outline { border: 1px solid #ddd; background: white; color: #555; }
        .btn-outline:hover { background: #f4f4f4; border-color: #ccc; }
        
        .btn-action { padding: 6px 10px; font-size: 0.8rem; margin-right: 5px; }
        .btn-edit { background: rgba(41, 128, 185, 0.1); color: var(--info); }
        .btn-edit:hover { background: var(--info); color: white; }
        .btn-danger { background: rgba(231, 76, 60, 0.1); color: var(--danger); }
        .btn-danger:hover { background: var(--danger); color: white; }
        .btn-reviews { background: rgba(243, 156, 18, 0.1); color: var(--warning); }
        .btn-reviews:hover { background: var(--warning); color: white; }
        
        .btn-cancel { background: #95a5a6; color: white; display: none; }

        /* Table */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #f8f9fa; padding: 15px; text-align: left; font-weight: 600; color: #555; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #eee; }
        td { padding: 15px; border-bottom: 1px solid #f1f1f1; vertical-align: middle; font-size: 0.95rem; }
        td img { width: 50px; height: 50px; object-fit: cover; border-radius: 6px; border: 1px solid #eee; }
        tr:hover td { background: #fafafa; }

        /* Badges */
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .bg-cake { background: rgba(230, 126, 34, 0.15); color: #d35400; }
        .bg-sav { background: rgba(39, 174, 96, 0.15); color: #27ae60; }
        .bg-swt { background: rgba(155, 89, 182, 0.15); color: #8e44ad; }

        /* Hidden file input for import */
        #import-file { display: none; }

        /* --- REVIEW MODAL --- */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); z-index: 1000; display: none; 
            justify-content: center; align-items: center; 
        }
        .modal-box { 
            background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.2); max-height: 80vh; overflow-y: auto; 
        }
        .review-list { margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; }
        .review-item { 
            background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 10px; 
            position: relative; border-left: 3px solid var(--primary); 
        }
        .review-header { display: flex; justify-content: space-between; font-size: 0.85rem; color: #666; margin-bottom: 5px; }
        .review-text { font-size: 0.95rem; color: #333; }
        .delete-rev-btn { 
            position: absolute; top: 10px; right: 10px; color: #aaa; cursor: pointer; transition: 0.2s; 
        }
        .delete-rev-btn:hover { color: var(--danger); }
        .add-review-form { margin-top: 20px; background: #fff; padding: 15px; border: 1px solid #eee; border-radius: 8px; }
        .star-rating i { color: #ffd700; }

        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            .admin-header { padding: 15px 20px; flex-direction: column; gap: 15px; }
        }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div class="login-overlay" id="login-screen">
        <div class="login-box">
            <h2>Admin Panel</h2>
            <p style="margin-bottom:20px; color:#666;">Soft Cake Management</p>
            <input type="text" id="admin-user" class="login-input" placeholder="Username (admin)">
            <input type="password" id="admin-pass" class="login-input" placeholder="Password (admin123)">
            <button class="btn btn-primary" style="width:100%; justify-content:center;" onclick="authenticate()">Login</button>
        </div>
    </div>

    <div class="modal-overlay" id="reviews-modal">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 id="rev-modal-title">Manage Reviews</h3>
                <span style="cursor:pointer; font-size:1.5rem;" onclick="closeReviewsModal()">Ã—</span>
            </div>
            
            <div class="review-list" id="reviews-container">
                </div>
            
            <div class="add-review-form">
                <h4 style="margin-bottom:10px;">Add Manual Review</h4>
                <input type="text" id="new-rev-user" placeholder="Customer Name" style="margin-bottom:10px;">
                <textarea id="new-rev-text" placeholder="Review content..." rows="2" style="margin-bottom:10px;"></textarea>
                <div style="margin-bottom:10px;">
                    <label>Rating:</label>
                    <select id="new-rev-rating" style="width:auto;">
                        <option value="5">5 Stars</option>
                        <option value="4">4 Stars</option>
                        <option value="3">3 Stars</option>
                        <option value="2">2 Stars</option>
                        <option value="1">1 Star</option>
                    </select>
                </div>
                <button class="btn btn-primary btn-sm" onclick="addManualReview()">Add Review</button>
            </div>
        </div>
    </div>

    <div id="dashboard" style="display:none;">
        
        <header class="admin-header">
            <div class="logo">Soft<span>Cake</span>. Admin</div>
            <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
                <button class="btn btn-outline" onclick="triggerImport()"><i class="fas fa-file-upload"></i> Restore JSON</button>
                <input type="file" id="import-file" accept=".json" onchange="importData(this)">
                
                <button class="btn btn-outline" onclick="exportData()"><i class="fas fa-download"></i> Backup JSON</button>
                <button class="btn btn-success" onclick="exportToCSV()"><i class="fas fa-file-excel"></i> Export Excel</button>
                <button class="btn btn-outline" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </header>

        <div class="main-container">
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="stat-total">0</h3>
                    <p>Total Items</p>
                </div>
                <div class="stat-card">
                    <h3 id="stat-cakes">0</h3>
                    <p>Cakes</p>
                </div>
                <div class="stat-card">
                    <h3 id="stat-sav">0</h3>
                    <p>Savoury</p>
                </div>
                <div class="stat-card">
                    <h3 id="stat-swt">0</h3>
                    <p>Sweets</p>
                </div>
            </div>

            <div class="panel" id="form-panel">
                <div class="panel-header">
                    <h3 id="form-title">Add New Product</h3>
                    <button class="btn btn-outline btn-action" onclick="resetForm()">Clear Form</button>
                </div>
                <div class="form-grid">
                    <div class="input-group">
                        <label>Product Name</label>
                        <input type="text" id="p-name" placeholder="e.g. Chocolate Cake">
                    </div>
                    
                    <div class="input-group">
                        <label>Price (LKR)</label>
                        <input type="number" id="p-price" placeholder="e.g. 1500">
                    </div>
                    
                    <div class="input-group">
                        <label>Category</label>
                        <select id="p-cat">
                            <option value="cakes">Cake</option>
                            <option value="savoury">Savoury</option>
                            <option value="sweets">Sweets</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label>Tags (For Filters)</label>
                        <input type="text" id="p-tags" placeholder="e.g. creamy, chocolate">
                    </div>

                    <div class="input-group full-width">
                        <label>Image (Upload File OR Paste URL)</label>
                        <div style="display:flex; gap:10px;">
                            <input type="file" id="p-file" accept="image/*" style="flex:1;">
                            <input type="text" id="p-img" placeholder="https://..." style="flex:1;">
                        </div>
                        <small style="color:#888;">Uploading automatically compresses image for storage.</small>
                    </div>

                    <div class="input-group full-width">
                        <label>Description (Product Details Tab)</label>
                        <textarea id="p-desc" placeholder="Detailed description of the item..." rows="3"></textarea>
                    </div>

                    <div class="input-group full-width">
                        <label>Ingredients (Ingredients Tab)</label>
                        <textarea id="p-ingr" placeholder="e.g. Flour, Sugar, Eggs, Butter, Vanilla Extract..." rows="2"></textarea>
                    </div>

                    <div class="input-group full-width" style="display:flex; align-items:center; gap:10px; background:#f9f9f9; padding:10px; border-radius:5px;">
                        <input type="checkbox" id="p-sale" style="width:auto; cursor:pointer;">
                        <label for="p-sale" style="cursor:pointer; margin:0;">Mark as On Sale / Best Seller</label>
                    </div>
                    
                    <div class="full-width" style="display:flex; gap:10px; margin-top:10px;">
                        <button id="btn-submit" class="btn btn-primary" style="flex:1; justify-content:center;" onclick="handleFormSubmit()">
                            <i class="fas fa-plus"></i> Add Product
                        </button>
                        <button id="btn-cancel" class="btn btn-cancel" onclick="cancelEditMode()">Cancel Edit</button>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <h3>Current Inventory</h3>
                    
                    <div class="search-bar">
                        <input type="text" id="search-input" placeholder="Search products..." onkeyup="filterProducts()">
                        <select id="filter-cat" onchange="filterProducts()" style="width:150px;">
                            <option value="all">All Cats</option>
                            <option value="cakes">Cakes</option>
                            <option value="savoury">Savoury</option>
                            <option value="sweets">Sweets</option>
                        </select>
                    </div>
                </div>

                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Price</th>
                                <th>Status</th>
                                <th style="text-align:right">Control</th>
                            </tr>
                        </thead>
                        <tbody id="product-table">
                            </tbody>
                    </table>
                    <div id="no-results" style="text-align:center; padding:30px; display:none; color:#888;">
                        No products found matching your search.
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- GLOBAL VARIABLES ---
        let products = [];
        let editIndex = -1; // -1 means Add Mode
        let currentReviewIndex = -1; // For Review Modal

        // --- AUTHENTICATION ---
        window.onload = function() {
            if(sessionStorage.getItem('isLoggedIn') === 'true') {
                showDashboard();
            }
        };

        function authenticate() {
            const u = document.getElementById('admin-user').value;
            const p = document.getElementById('admin-pass').value;
            if(u === 'admin' && p === 'admin123') {
                sessionStorage.setItem('isLoggedIn', 'true');
                showDashboard();
                showToast("Welcome back, Admin!", "success");
            } else {
                showToast("Invalid Credentials", "error");
            }
        }

        function logout() {
            sessionStorage.removeItem('isLoggedIn');
            location.reload();
        }

        function showDashboard() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            loadData();
        }

        // --- DATA MANAGEMENT ---
        function loadData() {
            const storedData = JSON.parse(localStorage.getItem('softCakeProducts'));
            if (!storedData || storedData.length === 0) {
                products = []; 
            } else {
                products = storedData;
            }
            renderTable(products);
            updateStats();
        }

        function renderTable(data) {
            const table = document.getElementById('product-table');
            const noRes = document.getElementById('no-results');
            table.innerHTML = "";

            if(data.length === 0) {
                noRes.style.display = "block";
                return;
            }
            noRes.style.display = "none";

            data.forEach((item) => {
                const originalIndex = products.findIndex(p => p.id === item.id);
                let badgeClass = 'bg-sav';
                if(item.cat === 'cakes') badgeClass = 'bg-cake';
                if(item.cat === 'sweets') badgeClass = 'bg-swt';
                let saleBadge = item.sale ? '<i class="fas fa-star" style="color:#e74c3c;"></i>' : '';

                const row = `
                    <tr>
                        <td><img src="${item.img}" alt="img" onerror="this.src='https://via.placeholder.com/50'"></td>
                        <td><strong>${item.name}</strong> ${saleBadge}</td>
                        <td><span class="badge ${badgeClass}">${item.cat.toUpperCase()}</span></td>
                        <td>Rs. ${item.price}</td>
                        <td style="color:${item.sale ? 'var(--danger)' : '#888'}">${item.sale ? 'On Sale' : 'Regular'}</td>
                        <td style="text-align:right">
                            <button class="btn btn-action btn-reviews" onclick="openReviewsModal(${originalIndex})" title="Manage Reviews"><i class="fas fa-comment-alt"></i></button>
                            <button class="btn btn-action btn-edit" onclick="editProduct(${originalIndex})" title="Edit Details"><i class="fas fa-pen"></i></button>
                            <button class="btn btn-action btn-danger" onclick="deleteProduct(${originalIndex})" title="Delete"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                table.innerHTML += row;
            });
        }

        function updateStats() {
            document.getElementById('stat-total').innerText = products.length;
            document.getElementById('stat-cakes').innerText = products.filter(p=>p.cat==='cakes').length;
            document.getElementById('stat-sav').innerText = products.filter(p=>p.cat==='savoury').length;
            document.getElementById('stat-swt').innerText = products.filter(p=>p.cat==='sweets').length;
        }

        function filterProducts() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const cat = document.getElementById('filter-cat').value;

            const filtered = products.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(query) || (item.tags && item.tags.toLowerCase().includes(query));
                const matchesCat = (cat === 'all') || (item.cat === cat);
                return matchesSearch && matchesCat;
            });
            renderTable(filtered);
        }

        // --- FORM HANDLING (Includes Description & Ingredients) ---
        function handleFormSubmit() {
            const name = document.getElementById('p-name').value;
            const price = document.getElementById('p-price').value;
            const cat = document.getElementById('p-cat').value;
            const tags = document.getElementById('p-tags').value;
            const urlImg = document.getElementById('p-img').value;
            const desc = document.getElementById('p-desc').value;
            const ingr = document.getElementById('p-ingr').value; // New Ingredient Field
            const isSale = document.getElementById('p-sale').checked;
            const fileInput = document.getElementById('p-file');

            if(!name || !price) {
                showToast("Please fill in Name and Price!", "error");
                return;
            }

            if (fileInput.files && fileInput.files[0]) {
                resizeImage(fileInput.files[0], function(resizedBase64) {
                    saveData(name, price, cat, tags, resizedBase64, desc, ingr, isSale);
                });
            } else if (urlImg.trim() !== "") {
                saveData(name, price, cat, tags, urlImg, desc, ingr, isSale);
            } else if (editIndex > -1) {
                saveData(name, price, cat, tags, products[editIndex].img, desc, ingr, isSale);
            } else {
                saveData(name, price, cat, tags, 'https://via.placeholder.com/300?text=No+Image', desc, ingr, isSale);
            }
        }

        function saveData(name, price, cat, tags, img, desc, ingr, isSale) {
            // Get existing reviews if editing, else empty array
            let existingReviews = (editIndex > -1 && products[editIndex].reviews) ? products[editIndex].reviews : [];

            const productObj = {
                id: (editIndex > -1) ? products[editIndex].id : Date.now(),
                name: name,
                price: parseInt(price),
                cat: cat,
                tags: tags,
                img: img,
                desc: desc || 'Freshly baked goodness.',
                ingr: ingr || 'Flour, Sugar, Eggs, Butter.', // Save Ingredients
                sale: isSale,
                reviews: existingReviews // Preserve reviews
            };

            if (editIndex > -1) {
                products[editIndex] = productObj;
                showToast("Product details updated!", "success");
            } else {
                products.push(productObj);
                showToast("New Product added!", "success");
            }

            saveAndRefresh();
            cancelEditMode();
        }

        function resizeImage(file, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 400; 
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const dataUrl = canvas.toDataURL(file.type, 0.7); 
                    callback(dataUrl);
                }
                img.src = e.target.result;
            }
            reader.readAsDataURL(file);
        }

        function editProduct(index) {
            editIndex = index;
            const item = products[index];

            document.getElementById('form-panel').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('form-title').innerText = "Edit: " + item.name;
            document.getElementById('btn-submit').innerHTML = '<i class="fas fa-save"></i> Update Product';
            document.getElementById('btn-cancel').style.display = "inline-flex";

            document.getElementById('p-name').value = item.name;
            document.getElementById('p-price').value = item.price;
            document.getElementById('p-cat').value = item.cat;
            document.getElementById('p-tags').value = item.tags || "";
            document.getElementById('p-desc').value = item.desc;
            document.getElementById('p-ingr').value = item.ingr || ""; // Load Ingredients
            document.getElementById('p-sale').checked = item.sale;
            document.getElementById('p-img').value = ""; 
            document.getElementById('p-file').value = "";
        }

        function cancelEditMode() {
            editIndex = -1;
            document.getElementById('form-title').innerText = "Add New Product";
            document.getElementById('btn-submit').innerHTML = '<i class="fas fa-plus"></i> Add Product';
            document.getElementById('btn-cancel').style.display = "none";
            resetForm();
        }

        function resetForm() {
            document.getElementById('p-name').value = '';
            document.getElementById('p-price').value = '';
            document.getElementById('p-img').value = '';
            document.getElementById('p-file').value = '';
            document.getElementById('p-tags').value = '';
            document.getElementById('p-desc').value = '';
            document.getElementById('p-ingr').value = '';
            document.getElementById('p-sale').checked = false;
        }

        function deleteProduct(index) {
            if(confirm("Are you sure you want to delete this item?")) {
                products.splice(index, 1);
                saveAndRefresh();
                showToast("Item deleted.", "error");
            }
        }

        // --- REVIEWS MANAGEMENT LOGIC ---
        function openReviewsModal(index) {
            currentReviewIndex = index;
            const item = products[index];
            document.getElementById('rev-modal-title').innerText = `Manage Reviews: ${item.name}`;
            document.getElementById('reviews-modal').style.display = 'flex';
            renderReviewsList(item.reviews || []);
        }

        function closeReviewsModal() {
            document.getElementById('reviews-modal').style.display = 'none';
            currentReviewIndex = -1;
        }

        function renderReviewsList(reviews) {
            const container = document.getElementById('reviews-container');
            container.innerHTML = "";

            if(!reviews || reviews.length === 0) {
                container.innerHTML = "<p style='color:#999; text-align:center;'>No reviews yet.</p>";
                return;
            }

            reviews.forEach((rev, i) => {
                let stars = "";
                for(let s=0; s<rev.rating; s++) stars += '<i class="fas fa-star"></i>';
                
                const div = document.createElement('div');
                div.className = 'review-item';
                div.innerHTML = `
                    <div class="review-header">
                        <strong>${rev.user}</strong>
                        <span class="star-rating">${stars}</span>
                    </div>
                    <div class="review-text">${rev.text}</div>
                    <i class="fas fa-trash delete-rev-btn" onclick="deleteReview(${i})"></i>
                `;
                container.appendChild(div);
            });
        }

        function addManualReview() {
            if(currentReviewIndex === -1) return;
            const user = document.getElementById('new-rev-user').value;
            const text = document.getElementById('new-rev-text').value;
            const rating = parseInt(document.getElementById('new-rev-rating').value);

            if(!user || !text) { showToast("Enter User and Review Text", "error"); return; }

            if(!products[currentReviewIndex].reviews) products[currentReviewIndex].reviews = [];
            
            products[currentReviewIndex].reviews.push({
                user: user,
                text: text,
                rating: rating,
                date: new Date().toLocaleDateString()
            });

            // Save
            saveAndRefresh();
            renderReviewsList(products[currentReviewIndex].reviews);
            
            // Clear inputs
            document.getElementById('new-rev-user').value = "";
            document.getElementById('new-rev-text').value = "";
            showToast("Review Added!", "success");
        }

        function deleteReview(revIdx) {
            if(confirm("Delete this review?")) {
                products[currentReviewIndex].reviews.splice(revIdx, 1);
                saveAndRefresh();
                renderReviewsList(products[currentReviewIndex].reviews);
                showToast("Review Deleted", "success");
            }
        }

        // --- EXPORT & IMPORT ---
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(products));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "softcake_backup_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function exportToCSV() {
            if(products.length === 0) { showToast("No data to export", "error"); return; }
            let csvContent = "data:text/csv;charset=utf-8,ID,Name,Category,Price,Tags,Description,Ingredients\n";
            products.forEach(function(row) {
                let cleanName = row.name.replace(/,/g, " ");
                let cleanDesc = (row.desc || "").replace(/,/g, " ").replace(/\n/g, " ");
                let cleanIngr = (row.ingr || "").replace(/,/g, " ").replace(/\n/g, " ");
                let cleanTags = (row.tags || "").replace(/,/g, "|");
                let rowStr = `${row.id},${cleanName},${row.cat},${row.price},${cleanTags},${cleanDesc},${cleanIngr}`;
                csvContent += rowStr + "\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "softcake_products.csv");
            document.body.appendChild(link);
            link.click();
            link.remove();
            showToast("Excel/CSV downloaded!", "success");
        }

        function triggerImport() { document.getElementById('import-file').click(); }

        function importData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(Array.isArray(data)) {
                        if(confirm("Overwrite current data?")) {
                            products = data;
                            saveAndRefresh();
                            showToast("Data Restored Successfully!", "success");
                        }
                    } else { showToast("Invalid JSON", "error"); }
                } catch(err) { showToast("Error reading file", "error"); }
            };
            reader.readAsText(file);
        }

        function saveAndRefresh() {
            localStorage.setItem('softCakeProducts', JSON.stringify(products));
            updateStats();
            filterProducts();
        }

        function showToast(message, type) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}" style="color:${type==='success'?'var(--success)':'var(--danger)'}"></i> ${message}`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
        }
    </script>
</body>
</html>